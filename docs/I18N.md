# 国际化(i18n)系统文档

## 概述

xzChat 内置了完整的国际化(i18n)支持,允许应用支持多种语言。系统提供了灵活的翻译管理、语言切换、格式化等功能。

## 特性

- ✅ **多语言支持** - 支持任意数量的语言
- ✅ **嵌套键** - 支持点号分隔的嵌套翻译键
- ✅ **参数插值** - 支持模板变量替换
- ✅ **回退机制** - 翻译缺失时自动回退到默认语言
- ✅ **命名空间** - 为插件或模块创建独立翻译空间
- ✅ **缓存优化** - 可选的翻译结果缓存
- ✅ **格式化工具** - 内置数字、日期、货币格式化
- ✅ **批量翻译** - 高效的批量翻译功能
- ✅ **类型安全** - 完整的 TypeScript 类型定义

## 快速开始

### 1. 基本使用

```javascript
import { i18n, t, setLocale } from './lib/i18n/index.js';

// 加载翻译
i18n.load('zh-CN', {
  app: {
    name: 'xzChat',
    welcome: '欢迎使用 {{name}}'
  }
});

// 翻译文本
console.log(t('app.name')); // xzChat
console.log(t('app.welcome', { name: 'xzChat' })); // 欢迎使用 xzChat
```

### 2. 切换语言

```javascript
// 加载多种语言
i18n.load('zh-CN', { hello: '你好' });
i18n.load('en-US', { hello: 'Hello' });

// 切换语言
setLocale('en-US');
console.log(t('hello')); // Hello

setLocale('zh-CN');
console.log(t('hello')); // 你好
```

### 3. 从目录加载翻译

```javascript
import { I18n } from './lib/i18n/index.js';

const i18n = new I18n({
  localeDirectory: './lib/i18n/locales',
  defaultLocale: 'zh-CN'
});

// 自动加载目录中的所有 .json 翻译文件
```

## API 参考

### I18n 类

#### 构造函数

```javascript
new I18n(options)
```

**参数:**
- `options` (Object) - 配置选项
  - `defaultLocale` (string) - 默认语言代码,默认 `'zh-CN'`
  - `availableLocales` (Array) - 可用语言列表,默认 `['zh-CN', 'en-US']`
  - `fallbackLocale` (string) - 回退语言,默认 `'zh-CN'`
  - `autoDetect` (boolean) - 是否自动检测系统语言,默认 `true`
  - `cacheTranslations` (boolean) - 是否缓存翻译结果,默认 `true`
  - `localeDirectory` (string) - 翻译文件目录路径

#### 方法

##### init(options)

初始化 i18n 系统。

```javascript
i18n.init({
  defaultLocale: 'en-US',
  localeDirectory: './locales'
});
```

##### load(locale, messages)

加载翻译消息。

```javascript
i18n.load('zh-CN', {
  app: {
    name: '应用名称'
  }
});
```

##### t(key, params, locale)

翻译文本。

**参数:**
- `key` (string) - 翻译键,支持点号分隔的嵌套路径
- `params` (Object) - 替换参数对象,可选
- `locale` (string) - 目标语言,可选(默认当前语言)

**返回:** (string) 翻译后的文本

```javascript
t('app.name');
t('app.welcome', { name: 'xzChat' });
t('app.welcome', { name: 'xzChat' }, 'en-US');
```

##### setLocale(locale)

设置当前语言。

**参数:**
- `locale` (string) - 语言代码

**返回:** (boolean) 是否设置成功

```javascript
setLocale('en-US');
```

##### getLocale()

获取当前语言。

**返回:** (string) 当前语言代码

```javascript
const currentLocale = getLocale();
```

##### getAvailableLocales()

获取可用语言列表。

**返回:** (Array) 语言代码列表

```javascript
const locales = i18n.getAvailableLocales();
// ['zh-CN', 'en-US']
```

##### exists(key, locale)

检查翻译是否存在。

**参数:**
- `key` (string) - 翻译键
- `locale` (string) - 语言代码,可选

**返回:** (boolean) 是否存在

```javascript
const exists = i18n.exists('app.name');
```

##### getLanguageName(locale, displayLocale)

获取语言名称。

**参数:**
- `locale` (string) - 语言代码
- `displayLocale` (string) - 显示语言,可选

**返回:** (string) 语言名称

```javascript
const name = i18n.getLanguageName('zh-CN', 'en-US');
// "简体中文"
```

##### translateBatch(keys, params, locale)

批量翻译。

**参数:**
- `keys` (Array) - 翻译键数组
- `params` (Object) - 参数对象,可选
- `locale` (string) - 目标语言,可选

**返回:** (Object) 翻译结果对象

```javascript
const translations = i18n.translateBatch(
  ['welcome', 'goodbye', 'thanks'],
  { name: 'xzChat' }
);
// { welcome: '欢迎 xzChat', goodbye: '再见', thanks: '谢谢' }
```

##### namespace(namespace)

创建命名空间翻译函数。

**参数:**
- `namespace` (string) - 命名空间前缀

**返回:** (Function) 翻译函数

```javascript
const tMessages = i18n.namespace('messages.error');
console.log(tMessages('notFound', { item: '文件' }));
```

##### clearCache()

清除翻译缓存。

```javascript
i18n.clearCache();
```

##### reset()

重置到初始状态。

```javascript
i18n.reset();
```

##### exportTranslations(locale)

导出当前语言的所有翻译。

**参数:**
- `locale` (string) - 语言代码,可选

**返回:** (Object) 翻译对象

```javascript
const translations = i18n.exportTranslations('zh-CN');
```

## 全局函数

### t(key, params, locale)

全局翻译函数。

```javascript
import { t } from './lib/i18n/index.js';

console.log(t('app.name'));
```

### setLocale(locale)

全局设置语言。

```javascript
import { setLocale } from './lib/i18n/index.js';

setLocale('en-US');
```

### getLocale()

全局获取当前语言。

```javascript
import { getLocale } from './lib/i18n/index.js';

const locale = getLocale();
```

### createNamespace(namespace)

全局创建命名空间。

```javascript
import { createNamespace } from './lib/i18n/index.js';

const tCommands = createNamespace('commands');
```

## 格式化函数

### formatNumber(number, options, locale)

格式化数字。

```javascript
import { formatNumber } from './lib/i18n/index.js';

formatNumber(1234.56, { minimumFractionDigits: 2 });
// 1,234.56

formatNumber(1234.56, { minimumFractionDigits: 2 }, 'en-US');
// 1,234.56
```

### formatDate(date, options, locale)

格式化日期。

```javascript
import { formatDate } from './lib/i18n/index.js';

formatDate(new Date(), { year: 'numeric', month: 'long', day: 'numeric' });
// 2026年1月28日

formatDate(new Date(), { year: 'numeric', month: 'long', day: 'numeric' }, 'en-US');
// January 28, 2026
```

### formatCurrency(amount, currency, options, locale)

格式化货币。

```javascript
import { formatCurrency } from './lib/i18n/index.js';

formatCurrency(1234.56, 'CNY');
// ¥1,234.56

formatCurrency(1234.56, 'USD', {}, 'en-US');
// $1,234.56
```

### plural(count, key, pluralKey, params, locale)

复数形式。

```javascript
import { plural } from './lib/i18n/index.js';

i18n.load('en-US', {
  item: '1 item',
  items: '{{count}} items'
});

plural(1, 'item', 'items');
// 1 item

plural(5, 'item', 'items', { count: 5 });
// 5 items
```

## 翻译文件格式

翻译文件使用 JSON 格式:

```json
{
  "app": {
    "name": "xzChat",
    "version": "版本",
    "welcome": "欢迎使用 {{name}}"
  },
  "commands": {
    "session": {
      "summary": "管理会话",
      "subcommands": {
        "list": "列出所有会话"
      }
    }
  }
}
```

### 参数替换

使用 `{{param}}` 语法:

```json
{
  "welcome": "欢迎, {{username}}!",
  "fileNotFound": "文件未找到: {{filename}}"
}
```

使用时:

```javascript
t('welcome', { username: 'Alice' });
// 欢迎, Alice!

t('fileNotFound', { filename: 'config.json' });
// 文件未找到: config.json
```

## 命名空间

为插件或模块创建独立的翻译空间:

```javascript
import { createNamespace } from './lib/i18n/index.js';

// 为插件创建命名空间
const pluginT = createNamespace('plugins.timer');

// 加载翻译
i18n.load('zh-CN', {
  plugins: {
    timer: {
      started: '计时器已启动: {{seconds}}秒',
      stopped: '计时器已停止'
    }
  }
});

// 使用命名空间翻译
console.log(pluginT('started', { seconds: 60 }));
// 计时器已启动: 60秒
```

## 在命令行应用中使用

### 1. 初始化 i18n

```javascript
import { I18n } from './lib/i18n/index.js';

const i18n = new I18n({
  localeDirectory: './lib/i18n/locales',
  defaultLocale: 'zh-CN',
  autoDetect: true
});
```

### 2. 在命令中翻译

```javascript
export const sessionCommand = {
  name: 'session',
  summary: () => i18n.t('commands.session.summary'),
  subcommands: {
    list: () => i18n.t('commands.session.subcommands.list'),
    new: () => i18n.t('commands.session.subcommands.new')
  }
};
```

### 3. 用户消息

```javascript
function showSessionCreated(name) {
  console.log(i18n.t('session.created', { name }));
}

showSessionCreated('feature-x');
// 会话 'feature-x' 已创建
```

## 添加新语言

### 1. 创建翻译文件

在 `lib/i18n/locales/` 目录下创建新的 JSON 文件:

```bash
lib/i18n/locales/ja-JP.json
```

### 2. 定义翻译内容

```json
{
  "app": {
    "name": "xzChat",
    "welcome": "xzChatへようこそ"
  }
}
```

### 3. 更新可用语言列表

```javascript
i18n.availableLocales.push('ja-JP');
```

### 4. 在语言名称中添加

在各语言的翻译文件中添加:

```json
{
  "locales": {
    "ja-JP": "日本語"
  }
}
```

## 最佳实践

### 1. 使用嵌套结构

```javascript
// 推荐
{
  "commands": {
    "session": {
      "summary": "管理会话",
      "subcommands": {
        "list": "列出所有会话"
      }
    }
  }
}

// 不推荐
{
  "commands_session_summary": "管理会话",
  "commands_session_subcommands_list": "列出所有会话"
}
```

### 2. 为插件使用命名空间

```javascript
const pluginT = createNamespace('plugins.myPlugin');
```

### 3. 提供回退翻译

始终在默认语言中提供完整的翻译:

```javascript
const i18n = new I18n({
  defaultLocale: 'zh-CN',  // 主语言
  fallbackLocale: 'zh-CN' // 回退到主语言
});
```

### 4. 使用描述性的键名

```javascript
// 推荐
{
  "session": {
    "created": "会话已创建",
    "deleted": "会话已删除"
  }
}

// 不推荐
{
  "msg1": "会话已创建",
  "msg2": "会话已删除"
}
```

### 5. 参数使用有意义的名称

```javascript
// 推荐
t('file.notFound', { filename: 'config.json' });

// 不推荐
t('file.notFound', { x: 'config.json' });
```

## 故障排除

### 问题: 翻译未生效

**原因:** 可能是缓存导致的

**解决:** 清除缓存

```javascript
i18n.clearCache();
```

### 问题: 显示原始键名

**原因:** 翻译键不存在或语言未加载

**解决:** 检查翻译是否存在

```javascript
if (i18n.exists('app.name')) {
  console.log(i18n.t('app.name'));
} else {
  console.log('Translation not found');
}
```

### 问题: 参数未替换

**原因:** 参数名称不匹配

**解决:** 确保参数名称与模板中的占位符一致

```javascript
// 翻译
"welcome": "欢迎, {{username}}!"

// 使用
t('welcome', { username: 'Alice' });  // 正确
t('welcome', { name: 'Alice' });      // 错误
```

## 性能优化

### 1. 启用缓存

```javascript
const i18n = new I18n({
  cacheTranslations: true  // 默认已启用
});
```

### 2. 使用批量翻译

```javascript
// 推荐
const translations = i18n.translateBatch(['key1', 'key2', 'key3']);

// 不推荐
const t1 = i18n.t('key1');
const t2 = i18n.t('key2');
const t3 = i18n.t('key3');
```

### 3. 减少不必要的语言切换

```javascript
// 不推荐
for (const item of items) {
  i18n.setLocale('zh-CN');
  console.log(i18n.t('item.name', item));
  i18n.setLocale('en-US');
}

// 推荐
i18n.setLocale('zh-CN');
for (const item of items) {
  console.log(i18n.t('item.name', item));
}
```

## 示例

完整示例请参考: `examples/i18n-usage.js`

```bash
node examples/i18n-usage.js
```

## 相关文档

- [插件系统文档](PLUGIN_SYSTEM.md)
- [命令补全文档](TAB_COMPLETION.md)
- [快捷键文档](KEYBINDINGS.md)
