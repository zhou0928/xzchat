# æµ‹è¯•è¦†ç›–ç‡æå‡æŒ‡å—

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [å½“å‰è¦†ç›–ç‡çŠ¶æ€](#å½“å‰è¦†ç›–ç‡çŠ¶æ€)
- [è¦†ç›–ç‡ç›®æ ‡](#è¦†ç›–ç‡ç›®æ ‡)
- [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)
- [æå‡è¦†ç›–ç‡](#æå‡è¦†ç›–ç‡)
- [è¦†ç›–ç‡æŠ¥å‘Š](#è¦†ç›–ç‡æŠ¥å‘Š)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æ¦‚è¿°

æœ¬æ–‡æ¡£æŒ‡å¯¼å¦‚ä½•æå‡ xzChat é¡¹ç›®çš„æµ‹è¯•è¦†ç›–ç‡è‡³ 90%+ã€‚

### è¦†ç›–ç‡ç±»å‹

- **è¡Œè¦†ç›–ç‡** (Line Coverage) - æ‰§è¡Œçš„ä»£ç è¡Œæ¯”ä¾‹
- **åˆ†æ”¯è¦†ç›–ç‡** (Branch Coverage) - æ‰§è¡Œçš„æ¡ä»¶åˆ†æ”¯æ¯”ä¾‹
- **å‡½æ•°è¦†ç›–ç‡** (Function Coverage) - è°ƒç”¨çš„å‡½æ•°æ¯”ä¾‹
- **è¯­å¥è¦†ç›–ç‡** (Statement Coverage) - æ‰§è¡Œçš„è¯­å¥æ¯”ä¾‹

### ç›®æ ‡

- **æ€»ä½“ç›®æ ‡**: 90%+
- **æ ¸å¿ƒæ¨¡å—**: 95%+
- **å·¥å…·æ¨¡å—**: 85%+
- **UIæ¨¡å—**: 80%+

---

## å½“å‰è¦†ç›–ç‡çŠ¶æ€

### æ¨¡å—è¦†ç›–ç‡åˆ†æ

| æ¨¡å— | è¡Œè¦†ç›–ç‡ | åˆ†æ”¯è¦†ç›–ç‡ | å‡½æ•°è¦†ç›–ç‡ | çŠ¶æ€ |
|------|---------|-----------|-----------|------|
| `lib/utils/logger.js` | 95%+ | 90%+ | 100% | âœ… |
| `lib/utils/cache.js` | 90%+ | 85%+ | 100% | âœ… |
| `lib/themes/index.js` | 90%+ | 85%+ | 95%+ | âœ… |
| `lib/i18n/index.js` | 90%+ | 85%+ | 95%+ | âœ… |
| `lib/utils/progress.js` | 90%+ | 85%+ | 95%+ | âœ… |
| `lib/utils/connection-pool.js` | 90%+ | 85%+ | 95%+ | âœ… |
| `lib/utils/errors.js` | 85%+ | 80%+ | 90%+ | ğŸŸ¡ |
| `lib/utils/file-loader.js` | 85%+ | 80%+ | 90%+ | ğŸŸ¡ |
| `lib/audio.js` | 70%+ | 60%+ | 80%+ | ğŸ”´ |
| `lib/mcp-lite.js` | 70%+ | 60%+ | 80%+ | ğŸ”´ |
| `lib/chat.js` | 75%+ | 65%+ | 85%+ | ğŸ”´ |
| `lib/tools.js` | 80%+ | 70%+ | 85%+ | ğŸŸ¡ |
| `lib/config.js` | 85%+ | 75%+ | 90%+ | ğŸŸ¡ |
| `lib/history.js` | 85%+ | 75%+ | 90%+ | ğŸŸ¡ |
| `lib/rag.js` | 80%+ | 70%+ | 85%+ | ğŸŸ¡ |

**å›¾ä¾‹**:
- âœ… è¾¾åˆ°ç›®æ ‡ (90%+)
- ğŸŸ¡ éœ€è¦æ”¹è¿› (75-89%)
- ğŸ”´ éœ€è¦é‡ç‚¹æå‡ (<75%)

---

## è¦†ç›–ç‡ç›®æ ‡

### çŸ­æœŸç›®æ ‡ (1-2å‘¨)

- [x] `lib/utils/logger.js` - 95%+
- [x] `lib/utils/cache.js` - 90%+
- [x] `lib/themes/index.js` - 90%+
- [x] `lib/i18n/index.js` - 90%+
- [x] `lib/utils/progress.js` - 90%+
- [x] `lib/utils/connection-pool.js` - 90%+

### ä¸­æœŸç›®æ ‡ (2-4å‘¨)

- [ ] `lib/utils/errors.js` - 90%+
- [ ] `lib/utils/file-loader.js` - 90%+
- [ ] `lib/tools.js` - 90%+
- [ ] `lib/config.js` - 90%+
- [ ] `lib/history.js` - 90%+
- [ ] `lib/rag.js` - 90%+

### é•¿æœŸç›®æ ‡ (1-2ä¸ªæœˆ)

- [ ] `lib/audio.js` - 85%+
- [ ] `lib/mcp-lite.js` - 85%+
- [ ] `lib/chat.js` - 85%+
- [ ] **æ€»ä½“è¦†ç›–ç‡** - **90%+**

---

## æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•è¡¥å……

é’ˆå¯¹è¦†ç›–ç‡ä¸è¶³çš„æ¨¡å—è¡¥å……å•å…ƒæµ‹è¯•:

```javascript
// ç¤ºä¾‹: ä¸ºæœªè¦†ç›–çš„åˆ†æ”¯æ·»åŠ æµ‹è¯•
describe('å‡½æ•°è¾¹ç•Œæµ‹è¯•', () => {
  it('åº”è¯¥æµ‹è¯•è¾¹ç•Œæ¡ä»¶', () => {
    expect(func(0)).toBe('zero');
    expect(func(1)).toBe('one');
    expect(func(-1)).toBe('negative');
  });

  it('åº”è¯¥æµ‹è¯•null/undefined', () => {
    expect(func(null)).toBe('null');
    expect(func(undefined)).toBe('undefined');
  });
});
```

### 2. é›†æˆæµ‹è¯•å¢å¼º

å¢å¼ºæ¨¡å—é—´çš„é›†æˆæµ‹è¯•:

```javascript
describe('æ¨¡å—é›†æˆæµ‹è¯•', () => {
  it('åº”è¯¥æµ‹è¯•æ¨¡å—Aå’Œæ¨¡å—Bçš„äº¤äº’', async () => {
    const moduleA = new ModuleA();
    const moduleB = new ModuleB();

    const result = await moduleA.process(moduleB.data);
    expect(result).toBeDefined();
  });
});
```

### 3. E2Eæµ‹è¯•æ‰©å±•

æ‰©å±•ç«¯åˆ°ç«¯æµ‹è¯•è¦†ç›–æ›´å¤šåœºæ™¯:

```javascript
describe('å®Œæ•´ç”¨æˆ·æµç¨‹', () => {
  it('åº”è¯¥æµ‹è¯•ä»é…ç½®åˆ°èŠå¤©çš„å®Œæ•´æµç¨‹', async () => {
    // 1. åˆå§‹åŒ–é…ç½®
    await executeCLI('config init');

    // 2. è®¾ç½®APIå¯†é’¥
    await executeCLI('config --api-key=test-key');

    // 3. å‘é€æ¶ˆæ¯
    const result = await executeCLI('chat "Hello"');

    // 4. éªŒè¯ç»“æœ
    expect(result.success).toBe(true);
  });
});
```

### 4. è¾¹ç•Œå’Œå¼‚å¸¸æµ‹è¯•

é‡ç‚¹æµ‹è¯•è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µ:

```javascript
describe('è¾¹ç•Œå’Œå¼‚å¸¸æµ‹è¯•', () => {
  it('åº”è¯¥å¤„ç†ç©ºè¾“å…¥', () => {
    expect(func('')).toBe('empty');
  });

  it('åº”è¯¥å¤„ç†è¶…é•¿è¾“å…¥', () => {
    const longInput = 'A'.repeat(10000);
    expect(func(longInput)).toBeDefined();
  });

  it('åº”è¯¥å¤„ç†ç‰¹æ®Šå­—ç¬¦', () => {
    expect(func('\0\n\t\r')).toBeDefined();
  });

  it('åº”è¯¥æŠ›å‡ºé¢„æœŸçš„é”™è¯¯', () => {
    expect(() => func(invalidInput)).toThrow();
  });
});
```

### 5. åˆ†æ”¯è¦†ç›–ä¼˜åŒ–

ç¡®ä¿æ‰€æœ‰æ¡ä»¶åˆ†æ”¯éƒ½è¢«æµ‹è¯•:

```javascript
describe('åˆ†æ”¯è¦†ç›–', () => {
  it('åº”è¯¥è¦†ç›–æ‰€æœ‰ifåˆ†æ”¯', () => {
    // æ¡ä»¶ä¸ºtrue
    expect(func(true)).toBe('true');

    // æ¡ä»¶ä¸ºfalse
    expect(func(false)).toBe('false');
  });

  it('åº”è¯¥è¦†ç›–æ‰€æœ‰switch case', () => {
    expect(switchFunc('case1')).toBe('result1');
    expect(switchFunc('case2')).toBe('result2');
    expect(switchFunc('default')).toBe('default');
  });

  it('åº”è¯¥è¦†ç›–æ‰€æœ‰try/catchåˆ†æ”¯', async () => {
    // æ­£å¸¸æµç¨‹
    await func(true);

    // å¼‚å¸¸æµç¨‹
    await expect(func(false)).rejects.toThrow();
  });
});
```

---

## æå‡è¦†ç›–ç‡

### æ­¥éª¤1: ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
npm run test:coverage
```

### æ­¥éª¤2: åˆ†ææœªè¦†ç›–ä»£ç 

```bash
# æŸ¥çœ‹HTMLè¦†ç›–ç‡æŠ¥å‘Š
open coverage/index.html

# æŸ¥çœ‹æœªè¦†ç›–çš„æ–‡ä»¶
cat coverage/lcov-report/index.html | grep "coverage-summary"
```

### æ­¥éª¤3: è¯†åˆ«æœªè¦†ç›–åŒºåŸŸ

åœ¨è¦†ç›–ç‡æŠ¥å‘Šä¸­,æŸ¥æ‰¾:
- ğŸ”´ çº¢è‰²æ ‡è®°çš„æœªè¦†ç›–è¡Œ
- ğŸŸ¡ é»„è‰²æ ‡è®°çš„éƒ¨åˆ†è¦†ç›–è¡Œ
- æœªè¦†ç›–çš„å‡½æ•°
- æœªè¦†ç›–çš„åˆ†æ”¯

### æ­¥éª¤4: ç¼–å†™è¡¥å……æµ‹è¯•

ä¸ºæœªè¦†ç›–çš„ä»£ç ç¼–å†™æµ‹è¯•:

```javascript
// æœªè¦†ç›–ä»£ç ç¤ºä¾‹
if (condition) {
  return doSomething();
} else {
  return doSomethingElse();
}

// è¡¥å……æµ‹è¯•
it('åº”è¯¥æµ‹è¯•ifåˆ†æ”¯', () => {
  expect(func(true)).toBe(doSomethingResult);
});

it('åº”è¯¥æµ‹è¯•elseåˆ†æ”¯', () => {
  expect(func(false)).toBe(doSomethingElseResult);
});
```

### æ­¥éª¤5: éªŒè¯è¦†ç›–ç‡æå‡

```bash
npm run test:coverage

# æ¯”è¾ƒå‰åè¦†ç›–ç‡
git diff coverage/coverage-summary.json
```

---

## è¦†ç›–ç‡æŠ¥å‘Š

### ç”ŸæˆæŠ¥å‘Š

```bash
# æ–‡æœ¬æŠ¥å‘Š
npm run test:coverage -- --reporter=text

# HTMLæŠ¥å‘Š
npm run test:coverage -- --reporter=html

# JSONæŠ¥å‘Š
npm run test:coverage -- --reporter=json

# LCOVæŠ¥å‘Š
npm run test:coverage -- --reporter=lcov
```

### æŸ¥çœ‹æŠ¥å‘Š

```bash
# æŸ¥çœ‹HTMLæŠ¥å‘Š
open coverage/index.html

# æŸ¥çœ‹æ–‡æœ¬æŠ¥å‘Š
cat coverage/coverage-final.txt
```

### è¦†ç›–ç‡é˜ˆå€¼é…ç½®

åœ¨ `vitest.config.js` ä¸­è®¾ç½®é˜ˆå€¼:

```javascript
export default defineConfig({
  test: {
    coverage: {
      provider: 'v8',
      lines: 90,      // è¡Œè¦†ç›–ç‡é˜ˆå€¼
      functions: 90,  // å‡½æ•°è¦†ç›–ç‡é˜ˆå€¼
      branches: 85,    // åˆ†æ”¯è¦†ç›–ç‡é˜ˆå€¼
      statements: 90   // è¯­å¥è¦†ç›–ç‡é˜ˆå€¼
    }
  }
});
```

---

## æœ€ä½³å®è·µ

### 1. æµ‹è¯•ä¼˜å…ˆçº§

æŒ‰ä¼˜å…ˆçº§ç¼–å†™æµ‹è¯•:

1. **P0 - æ ¸å¿ƒåŠŸèƒ½** - åŸºæœ¬èŠå¤©ã€é…ç½®ç®¡ç†
2. **P1 - é‡è¦åŠŸèƒ½** - ä¼šè¯ç®¡ç†ã€å·¥å…·ç³»ç»Ÿ
3. **P2 - è¾…åŠ©åŠŸèƒ½** - æ—¥å¿—ã€ç¼“å­˜
4. **P3 - è¾¹ç¼˜åŠŸèƒ½** - UIç¾åŒ–ã€ä¸»é¢˜

### 2. æµ‹è¯•ç‹¬ç«‹æ€§

æ¯ä¸ªæµ‹è¯•åº”è¯¥ç‹¬ç«‹è¿è¡Œ:

```javascript
describe('ç‹¬ç«‹æµ‹è¯•', () => {
  beforeEach(async () => {
    // æ¯ä¸ªæµ‹è¯•å‰åˆ›å»ºç‹¬ç«‹ç¯å¢ƒ
    tempDir = await createTempDir();
  });

  afterEach(async () => {
    // æ¯ä¸ªæµ‹è¯•åæ¸…ç†ç¯å¢ƒ
    await cleanupTempDir(tempDir);
  });

  it('æµ‹è¯•ç”¨ä¾‹1', async () => {
    // ä¸ä¾èµ–å…¶ä»–æµ‹è¯•
  });

  it('æµ‹è¯•ç”¨ä¾‹2', async () => {
    // ä¸ä¾èµ–å…¶ä»–æµ‹è¯•
  });
});
```

### 3. ä½¿ç”¨æµ‹è¯•è¾…åŠ©å·¥å…·

åˆ©ç”¨è¾…åŠ©å·¥å…·ç®€åŒ–æµ‹è¯•:

```javascript
import {
  createTempDir,
  mockFetch,
  waitForCondition
} from './helpers.js';

describe('ä½¿ç”¨è¾…åŠ©å·¥å…·', () => {
  it('åº”è¯¥ç®€åŒ–æµ‹è¯•ä»£ç ', async () => {
    const tempDir = await createTempDir();
    mockFetch({ data: 'test' });

    await waitForCondition(async () => {
      return await condition();
    });
  });
});
```

### 4. æŒç»­é›†æˆ

åœ¨CI/CDä¸­è¿è¡Œè¦†ç›–ç‡æµ‹è¯•:

```yaml
# .github/workflows/coverage.yml
name: Coverage

on: [push, pull_request]

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm install
      - run: npm run test:coverage
      - uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
```

### 5. å®šæœŸå®¡æŸ¥

å®šæœŸå®¡æŸ¥è¦†ç›–ç‡æŠ¥å‘Š:

- æ¯å‘¨æ£€æŸ¥ä¸€æ¬¡è¦†ç›–ç‡å˜åŒ–
- è¯†åˆ«è¦†ç›–ç‡ä¸‹é™çš„æ¨¡å—
- åŠæ—¶è¡¥å……æµ‹è¯•ç”¨ä¾‹
- ä¿æŒè¦†ç›–ç‡æŒç»­æå‡

---

## è¦†ç›–ç‡æå‡æŠ€å·§

### 1. è¦†ç›–æ‰€æœ‰ä»£ç è·¯å¾„

```javascript
// åŸä»£ç 
function processData(data) {
  if (data) {
    return data.trim();
  }
  return '';
}

// æµ‹è¯•
it('åº”è¯¥å¤„ç†æœ‰æ•ˆæ•°æ®', () => {
  expect(processData('  test  ')).toBe('test');
});

it('åº”è¯¥å¤„ç†null/undefined', () => {
  expect(processData(null)).toBe('');
  expect(processData(undefined)).toBe('');
});
```

### 2. è¦†ç›–æ‰€æœ‰é”™è¯¯åœºæ™¯

```javascript
// åŸä»£ç 
try {
  await riskyOperation();
} catch (error) {
  if (error.code === 'ECONNREFUSED') {
    return 'connection refused';
  }
  return 'unknown error';
}

// æµ‹è¯•
it('åº”è¯¥å¤„ç†è¿æ¥æ‹’ç»', async () => {
  mockError({ code: 'ECONNREFUSED' });
  expect(await func()).toBe('connection refused');
});

it('åº”è¯¥å¤„ç†å…¶ä»–é”™è¯¯', async () => {
  mockError({ code: 'ENOTFOUND' });
  expect(await func()).toBe('unknown error');
});
```

### 3. è¦†ç›–å¼‚æ­¥ä»£ç 

```javascript
// åŸä»£ç 
async function fetchWithRetry(url, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      return await fetch(url);
    } catch (error) {
      if (i === retries - 1) throw error;
    }
  }
}

// æµ‹è¯•
it('åº”è¯¥æˆåŠŸè·å–æ•°æ®', async () => {
  mockFetch({ data: 'success' });
  expect(await fetchWithRetry('url')).toBeDefined();
});

it('åº”è¯¥åœ¨é‡è¯•åå¤±è´¥', async () => {
  let attempts = 0;
  mockFetch(() => {
    attempts++;
    if (attempts < 3) throw new Error('Error');
    return { data: 'success' };
  });

  expect(await fetchWithRetry('url')).toBeDefined();
});
```

### 4. è¦†ç›–æ‰€æœ‰çŠ¶æ€

```javascript
// åŸä»£ç 
function handleStatus(status) {
  switch (status) {
    case 'active':
      return 'running';
    case 'paused':
      return 'stopped';
    case 'completed':
      return 'done';
    default:
      return 'unknown';
  }
}

// æµ‹è¯•
it('åº”è¯¥å¤„ç†æ‰€æœ‰çŠ¶æ€', () => {
  expect(handleStatus('active')).toBe('running');
  expect(handleStatus('paused')).toBe('stopped');
  expect(handleStatus('completed')).toBe('done');
  expect(handleStatus('invalid')).toBe('unknown');
});
```

---

## æ•…éšœæ’é™¤

### é—®é¢˜: è¦†ç›–ç‡ä¸ä¸Šå‡

**åŸå› **: æµ‹è¯•æ²¡æœ‰è¦†ç›–æ–°çš„ä»£ç è·¯å¾„

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥æµ‹è¯•æ˜¯å¦çœŸçš„æ‰§è¡Œäº†ç›®æ ‡ä»£ç 
- ä½¿ç”¨è°ƒè¯•å·¥å…·éªŒè¯æ‰§è¡Œè·¯å¾„
- æ·»åŠ æ›´å¤šè¾¹ç•Œå’Œå¼‚å¸¸æµ‹è¯•

### é—®é¢˜: è¦†ç›–ç‡ä¸‹é™

**åŸå› **: æ–°ä»£ç æ²¡æœ‰å¯¹åº”çš„æµ‹è¯•

**è§£å†³æ–¹æ¡ˆ**:
- ä¸ºæ–°ä»£ç ç¼–å†™æµ‹è¯•
- ç¡®ä¿æµ‹è¯•é€šè¿‡åå†åˆå¹¶
- è®¾ç½®è¦†ç›–ç‡é˜ˆå€¼é˜²æ­¢ä¸‹é™

### é—®é¢˜: åˆ†æ”¯è¦†ç›–ç‡ä½

**åŸå› **: æ¡ä»¶åˆ†æ”¯æœªè¢«å…¨éƒ¨æµ‹è¯•

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿æ¯ä¸ªif/elseéƒ½è¢«æµ‹è¯•
- æµ‹è¯•æ‰€æœ‰switch case
- æµ‹è¯•æ‰€æœ‰try/catchåˆ†æ”¯

---

## æ€»ç»“

æå‡æµ‹è¯•è¦†ç›–ç‡æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹,éœ€è¦:

1. **å®šæœŸåˆ†æ**è¦†ç›–ç‡æŠ¥å‘Š
2. **æŒç»­è¡¥å……**ç¼ºå¤±çš„æµ‹è¯•
3. **ä¿æŒè´¨é‡**è€Œéä»…ä»…è¿½æ±‚æ•°å­—
4. **å…³æ³¨æ ¸å¿ƒ**åŠŸèƒ½çš„è¦†ç›–ç‡
5. **åˆ©ç”¨å·¥å…·**è‡ªåŠ¨åŒ–è¦†ç›–ç‡è·Ÿè¸ª

é€šè¿‡ç³»ç»ŸåŒ–çš„æµ‹è¯•ç­–ç•¥å’ŒæŒç»­çš„åŠªåŠ›,å¯ä»¥å°† xzChat çš„æµ‹è¯•è¦†ç›–ç‡æå‡è‡³ 90%+!

---

## ç›¸å…³æ–‡æ¡£

- [E2Eæµ‹è¯•æŒ‡å—](./E2E_TESTING.md)
- [æµ‹è¯•é…ç½®](../vitest.config.js)
- [æœ€ä½³å®è·µ](./BEST_PRACTICES.md)
